"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _ckeditorerror=_interopRequireDefault(require("@ckeditor/ckeditor5-utils/src/ckeditorerror")),_observablemixin=_interopRequireDefault(require("@ckeditor/ckeditor5-utils/src/observablemixin")),_mix=_interopRequireDefault(require("@ckeditor/ckeditor5-utils/src/mix"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}/**
 * @extends module:core/command~Command
 */function findOptimalInsertionPosition(a,b){var c=a.getSelectedElement();if(c&&b.schema.isBlock(c))return b.createPositionAfter(c);var d=a.getSelectedBlocks().next().value;if(d){// If inserting into an empty block â€“ return position in that block. It will get
// replaced with the image by insertContent(). #42.
if(d.isEmpty)return b.createPositionAt(d,0);var e=b.createPositionAfter(d);// If selection is at the end of the block - return position after the block.
return a.focus.isTouching(e)?e:b.createPositionBefore(d);// Otherwise return position before the block.
}return a.focus}function insertImage(a,b){var c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{},d=a.createElement("image",c),e=findOptimalInsertionPosition(b.document.selection,b);b.insertContent(d,e),d.parent&&a.setSelection(d,"on")}var MyFinderCommand=/*#__PURE__*/function(){/**
     * @inheritDoc
     */function a(b){var c=this;_classCallCheck(this,a),this.editor=b,window.myfinderChooseCallback=function(a,b,d,e){var f=c.editor.model;f.change(function(c){insertImage(c,f,{src:a,alt:e,title:b})})},this.value=void 0,this.isEnabled=!0,this.decorate("execute"),this.listenTo(this.editor.model.document,"change",function(){c.refresh()}),this.on("execute",function(a){c.isEnabled||a.stop()},{priority:"high"}),this.listenTo(b,"change:isReadOnly",function(a,b,d){d?(c.on("set:isEnabled",forceDisable,{priority:"highest"}),c.isEnabled=!1):(c.off("set:isEnabled",forceDisable),c.refresh())}),this.stopListening(this.editor.model.document,"change"),this.listenTo(this.editor.model.document,"change",function(){return c.refresh()},{priority:"low"})}/**
     * @inheritDoc
     */return _createClass(a,[{key:"refresh",value:function c(){var a=this.editor.commands.get("imageUpload"),b=this.editor.commands.get("link");this.isEnabled=a&&b&&(a.isEnabled||b.isEnabled)}/**
     * @inheritDoc
     */},{key:"execute",value:function e(){var a=this.editor,b=this.editor.config.get("ckfinder.openerMethod")||"modal";if("popup"!=b&&"modal"!=b)throw new _ckeditorerror.default("ckfinder-unknown-openerMethod: The openerMethod config option must by \"popup\" or \"modal\".");var c=this.editor.config.get("ckfinder.options")||{};c.chooseFiles=!0;var d=c.onInit;c.language||(c.language=a.locale.language),c.onInit=function(b){d&&d(),b.on("files:choose",function(c){var d=c.data.files.toArray(),e=d.filter(function(a){return!a.isImage()}),f=d.filter(function(a){return a.isImage()}),g=!0,h=!1,i=void 0;try{for(var j,k,l=e[Symbol.iterator]();!(g=(j=l.next()).done);g=!0)k=j.value,a.execute("link",k.getUrl())}catch(a){h=!0,i=a}finally{try{g||null==l.return||l.return()}finally{if(h)throw i}}var m=[],n=!0,o=!1,p=void 0;try{for(var q,r=f[Symbol.iterator]();!(n=(q=r.next()).done);n=!0){var s=q.value,t=s.getUrl();m.push(t?t:b.request("file:getProxyUrl",{file:s}))}}catch(a){o=!0,p=a}finally{try{n||null==r.return||r.return()}finally{if(o)throw p}}m.length&&insertImages(a,m)}),b.on("file:choose:resizedImage",function(b){var c=b.data.resizedUrl;if(!c){var d=a.plugins.get("Notification"),e=a.locale.t;return void d.showWarning(e("Could not obtain resized image URL."),{title:e("Selecting resized image failed"),namespace:"ckfinder"})}insertImages(a,[c])})},a.config._config.onOpen()}},{key:"destroy",value:function a(){this.stopListening()}}]),a}();exports.default=MyFinderCommand,(0,_mix.default)(MyFinderCommand,_observablemixin.default);function forceDisable(a){a.return=!1,a.stop()}function insertImages(a,b){var c=a.commands.get("imageUpload");if(!c.isEnabled){var d=a.plugins.get("Notification"),e=a.locale.t;return void d.showWarning(e("Could not insert image at the current position."),{title:e("Inserting image failed"),namespace:"ckfinder"})}a.execute("imageInsert",{source:b})}